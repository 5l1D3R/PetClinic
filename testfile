huge changes to the code